sap.ui.define([],function(){"use strict";jQuery.sap.require("sap.ovp.ui.UIActions");var R=function(s){this.init(s);};R.prototype.init=function(s){s.beforeDragCallback=this._beforeDragHandler.bind(this);s.dragStartCallback=this._dragStartHandler.bind(this);s.dragMoveCallback=this._dragMoveHandler.bind(this);s.dragEndCallback=this._dragEndHandler.bind(this);s.resizeStartCallback=this._resizeStartHandler.bind(this);s.resizeMoveCallback=this._resizeMoveHandler.bind(this);s.resizeEndCallback=this._resizeEndHandler.bind(this);s.endCallback=this._endHandler.bind(this);this.placeHolderClass=s.placeHolderClass;this.layout=s.layout;this.settings=s;this.destroy();this.uiActions=new sap.ovp.ui.UIActions(this.settings).enable();this.aCardsOrder=null;this.aCards=s.aCards;this.layoutUtil=s.layoutUtil;this.verticalMargin=null;this.horizontalMargin=null;this.top=null;this.left=null;this.width=null;this.layoutOffset=null;this.jqLayout=null;this.jqLayoutInner=null;this.isRTLEnabled=null;this.lastCollidedEl=null;this.rowHeight=s.rowHeight;this.dropZoneItem=null;this.floaterData=null;this.resizeData={};this.delta={top:0,left:0};switch(true){case sap.ui.Device.browser.webkit:this.cssVendorTransition="-webkit-transition";this.cssVendorTransform="-webkit-transform";break;case sap.ui.Device.browser.msie:this.cssVendorTransition="-ms-transition";this.cssVendorTransform="-ms-transform";break;case sap.ui.Device.browser.mozilla:this.cssVendorTransition="-moz-transition";this.cssVendorTransform="-moz-transform";break;default:this.cssVendorTransition="transition";this.cssVendorTransform="transform";}};R.prototype.destroy=function(){if(this.uiActions){this.uiActions.disable();this.uiActions=null;}};R.prototype._resizeStartHandler=function(e,c){var C=this.layoutUtil.dashboardLayoutModel.getCardById(this.layoutUtil.getCardId(c.id));if(C.template==="sap.ovp.cards.stack"){return;}if(jQuery(window).getSelection){var s=jQuery(window).getSelection();s.removeAllRanges();}this.initCardsSettings();};R.prototype._resizeEndHandler=function(e,u){if(sap.ui.Device.system.desktop){jQuery("body").removeClass("sapOVPDisableUserSelect sapOVPDisableImageDrag");}jQuery(this.settings.wrapper).removeClass("dragAndDropMode");jQuery("#ovpResizeGhost").remove();jQuery("#ovpResizeRubberBand").remove();if(!u){return;}if(this.resizeData.colSpan&&this.resizeData.rowSpan){this.layoutUtil.addColumnInTable(u.getAttribute("id"),this.resizeData);this.layoutUtil.resizeCard(u.getAttribute("id"),this.resizeData);}this.resizeData={};if(jQuery(window).getSelection){var s=jQuery(window).getSelection();s.removeAllRanges();}};R.prototype._resizeMoveHandler=function(a){var c=this.layoutUtil.dashboardLayoutModel.getCardById(this.layoutUtil.getCardId(a.element.id));if(c.template==="sap.ovp.cards.stack"){return;}if(a.element){var $=jQuery(a.element);var e=$.position().left;var E=$.position().top;var g=a.moveX-e-this.layoutOffset.left;var b=a.moveY-E-this.layoutOffset.top+this.jqLayout.scrollTop();this.resizeData.colSpan=Math.round(g/this.layoutUtil.getColWidthPx());if(this.resizeData.colSpan<1){this.resizeData.colSpan=1;}this.resizeData.rowSpan=Math.round(b/this.layoutUtil.getRowHeightPx());if((c.template==="sap.ovp.cards.charts.analytical")&&this.resizeData.rowSpan<4){this.resizeData.rowSpan=4;}else if((c.template!=="sap.ovp.cards.linklist")&&this.resizeData.rowSpan<3){this.resizeData.rowSpan=3;}var d=this.resizeData.rowSpan*this.layoutUtil.getRowHeightPx();var f=this.resizeData.colSpan*this.layoutUtil.getColWidthPx();if(f+e>this.layoutUtil.getLayoutWidthPx()){f=this.layoutUtil.getLayoutWidthPx()-e;this.resizeData.colSpan=Math.round(f/this.layoutUtil.getColWidthPx());}jQuery("#ovpResizeRubberBand").remove();var o=jQuery(a.element).parent();o.append("<div id='ovpResizeRubberBand' class='ovpResizeRubberBand' style='top: "+E+"px; left: "+e+"px; width: "+g+"px; height: "+b+"px;'></div>");jQuery("#ovpResizeGhost").remove();o.append("<div id='ovpResizeGhost' class='ovpCardResizeGhost' style='top: "+E+"px; left: "+e+"px; width: "+f+"px; height: "+d+"px;'></div>");}};R.prototype._beforeDragHandler=function(e,u){if(e.type==="mousedown"){e.preventDefault();}if(sap.ui.Device.system.desktop){jQuery("body").addClass("sapOVPDisableUserSelect sapOVPDisableImageDrag");}if(sap.ui.Device.browser.mobile){this.selectableElemets=jQuery(u).find(".sapUiSelectable");this.selectableElemets.removeClass("sapUiSelectable");}jQuery(this.settings.wrapper).addClass("dragAndDropMode");};R.prototype._dragStartHandler=function(e,c){jQuery.sap.log.info(c);if(jQuery(window).getSelection){var s=jQuery(window).getSelection();s.removeAllRanges();}this.initCardsSettings();var C=c.children[0].getBoundingClientRect();this.floaterData={width:C.width,height:C.height,startLeft:C.left-this.layoutOffset.left,startTop:C.top-this.layoutOffset.top-parseInt(jQuery("."+this.placeHolderClass).css("border-top-width"),10)};};R.prototype._dragMoveHandler=function(a){var f=jQuery(a.clone);this.floaterData.id=f.attr("id");this.floaterData.left=a.moveX-this.uiActions.startX+this.floaterData.startLeft;this.floaterData.top=a.moveY-this.uiActions.startY+this.floaterData.startTop+this.jqLayout.scrollTop();var d=this.layoutUtil.getDropSimData(this.floaterData);this.floaterData.top=d.cellPos.top;this.floaterData.left=d.cellPos.left;this.showGhostWhileDragMove(a.element,d.cellPos);this.floaterData.bPushHorizontal=d.pushHorizontal;if(jQuery(".displaceItem")[0]){jQuery(".displaceItem").css(this.getCSSTransition(0,0));jQuery(".sapUshellEasyScanLayoutInner").children().removeClass("displaceItem");}if(d.coveredCardIds.length>0){var o=this.layoutUtil.convertRemToPx("4rem");d.coveredCardIds.forEach(function(c){jQuery("#"+c).addClass("displaceItem");});jQuery(".displaceItem").css(d.pushHorizontal?this.getCSSTransition(o,0):this.getCSSTransition(0,o));}};R.prototype._dragEndHandler=function(e,f){this.lastCollidedEl=null;jQuery("#ovpDashboardLayoutMarker").remove();jQuery(".displaceItem").css(this.getCSSTransition(0,0));jQuery(".displaceItem").removeClass("displaceItem");var h=this.floaterData.bPushHorizontal;var g=this.layoutUtil.mapPositionToGrid({top:this.floaterData.top,left:this.floaterData.left});jQuery(f).css({left:this.floaterData.left,top:this.floaterData.top});this.layoutUtil.moveCardToGrid(this.floaterData.id,{column:g.gridCoordX,row:g.gridCoordY},h);if(sap.ui.Device.system.desktop){jQuery("body").removeClass("sapOVPDisableUserSelect sapOVPDisableImageDrag");}jQuery(this.settings.wrapper).removeClass("dragAndDropMode");if(jQuery(window).getSelection){var s=jQuery(window).getSelection();s.removeAllRanges();}};R.prototype._endHandler=function(e,u){jQuery.sap.log.info(u);if(sap.ui.Device.browser.mobile&&this.selectableElemets){this.selectableElemets.addClass("sapUiSelectable");}};R.prototype.initCardsSettings=function(){this.jqLayout=this.layout.$();this.jqLayoutInner=this.jqLayout.children().first();var l=this.jqLayout.scrollTop();var a=this.jqLayoutInner.height();this.isRTLEnabled=sap.ui.getCore().getConfiguration().getRTL()?1:-1;this.aCardsOrder=[];this.layoutOffset=this.jqLayout.offset();this.corrY=this.jqLayout.get(0).getBoundingClientRect().top+this.jqLayout.scrollTop();this.corrX=this.layoutOffset.left;this.columnCount=this.layoutUtil.oLayoutData.colCount;var v=this.layout.getVisibleLayoutItems();if(!v){return;}this.aCardsOrder=v.map(function(i){var e=i.$().parent()[0];e.posDnD={width:e.offsetWidth,height:e.offsetHeight};return e;});var j=this.jqLayoutInner.children().first();var m=(this.isRTLEnabled===1)?"margin-left":"margin-right";this.verticalMargin=parseInt(j.css(m),10);var f=this.aCardsOrder[0];this.horizontalMargin=parseInt(jQuery(f).css("margin-bottom"),10);this.verticalMargin=this.horizontalMargin;this.top=f.getBoundingClientRect().top-this.jqLayoutInner[0].getBoundingClientRect().top;this.left=f.getBoundingClientRect().left-this.jqLayoutInner[0].getBoundingClientRect().left;this.width=f.offsetWidth;jQuery(this.aCardsOrder).css("position","absolute");this.drawLayout(this.aCardsOrder);this.jqLayoutInner.height(a);this.jqLayout.scrollTop(l);};R.prototype.drawLayout=function(c){var C=[];for(var i=0;i<this.columnCount;i++){C[i]=0;}for(var n=0;n<c.length;n++){var d=c[n];var $=jQuery(c[n]);d.posDnD.top=$.position().top;d.posDnD.bottom=$.position().top+d.posDnD.height;d.posDnD.left=$.position().left;d.posDnD.right=$.position().left+d.posDnD.width;this.updateElementCSS(c[n]);}};R.prototype.showGhostWhileDragMove=function(h,g){if(jQuery("#ovpDashboardLayoutMarker").length===0){jQuery(".sapUshellEasyScanLayoutInner").append("<div id='ovpDashboardLayoutMarker' style= 'top: "+g.top+"px;"+"; left: "+g.left+"px;"+"; width: "+this.floaterData.width+"px;"+" height: "+this.floaterData.height+"px;"+"; position: absolute;'>"+"<div id='ovpDashboardLayoutMarkernner' class='sapOvpDasboardGhost' style= 'margin: 8px"+"; width: "+this.floaterData.width+"px;"+" height: "+this.floaterData.height+"px;'>"+"</div>"+"</div>");}else{jQuery("#ovpDashboardLayoutMarker").css({top:g.top+"px",left:g.left+"px"});}jQuery(h).css({left:g.left+2,top:g.top+2});};R.prototype.updateElementCSS=function(e){jQuery(e).css({top:e.posDnD.top,left:e.posDnD.left});};R.prototype.getCSSTransition=function(o,a){var c={};c[this.cssVendorTransition]="all 0.25s ease";c[this.cssVendorTransform]="translate3d("+o+"px, "+a+"px, 0px)";return c;};return R;});
