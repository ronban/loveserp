/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/dt/Plugin','sap/ui/rta/Utils','sap/ui/rta/command/CompositeCommand'],function(P,U,C){"use strict";var R=P.extend("sap.ui.rta.plugin.Remove",{metadata:{library:"sap.ui.rta",properties:{},associations:{},events:{}}});R.prototype.registerElementOverlay=function(o){o.attachBrowserEvent("keydown",this._onKeyDown,this);};R.prototype._getEffectiveDesignTimeMetadata=function(o){var d;if(o.isInHiddenTree()){var p=o.getPublicParentAggregationOverlay();d=p.getDesignTimeMetadata();}else{d=o.getDesignTimeMetadata();}return d;};R.prototype._getRemoveAction=function(o){return this._getEffectiveDesignTimeMetadata(o).getAction("remove",o.getElementInstance());};R.prototype.isRemoveAvailable=function(o){return!!this._getRemoveAction(o);};R.prototype.isRemoveEnabled=function(o){var a=this._getRemoveAction(o);if(!a){return false;}if(typeof a.isEnabled!=="undefined"){if(typeof a.isEnabled==="function"){return a.isEnabled(o.getElementInstance());}else{return a.isEnabled;}}return true;};R.prototype._getConfirmationText=function(o){var a=this._getRemoveAction(o);if(a&&a.getConfirmationText){return a.getConfirmationText(o.getElementInstance());}};R.prototype.deregisterElementOverlay=function(o){o.detachBrowserEvent("keydown",this._onKeyDown,this);};R.prototype._onKeyDown=function(e){if(e.keyCode===jQuery.sap.KeyCodes.DELETE){e.stopPropagation();this.removeElement();}};R.prototype.removeElement=function(o){var s;if(o){s=o;}else{var d=this.getDesignTime();s=d.getSelection();}if(s.length>0){this._handleRemove(s);}};R.prototype._getRemoveCommand=function(e,r,d){return this.getCommandFactory().getCommandFor(e,"Remove",{removedElement:r},d);};R.prototype._fireElementModified=function(c){if(c.getCommands().length){this.fireElementModified({"command":c});}};R.prototype._handleRemove=function(s){var t=this;var p=[];var c=new C();s.forEach(function(o){var a;var r=o.getElementInstance();var e;var d=t._getEffectiveDesignTimeMetadata(o);if(o.isInHiddenTree()){e=o.getPublicParentElementOverlay().getElementInstance();}else{e=r;}if(t.isRemoveEnabled(o)){var b=t._getConfirmationText(o);if(b){p.push(U.openRemoveConfirmationDialog(r,b).then(function(f){if(f){a=t._getRemoveCommand(e,r,d);c.addCommand(a);}}));}else{a=t._getRemoveCommand(e,r,d);c.addCommand(a);}}});if(p.length){Promise.all(p).then(function(){t._fireElementModified(c);});}else{t._fireElementModified(c);}};return R;},true);
