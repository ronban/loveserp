/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/rta/command/BaseCommand','sap/ui/rta/Utils','sap/ui/rta/controlAnalyzer/ControlAnalyzerFactory'],function(B,U,C){"use strict";var a=B.extend("sap.ui.rta.command.Ungroup",{metadata:{library:"sap.ui.rta",properties:{changeType:{type:"string",defaultValue:"UngroupControl"},smartForm:{type:"object"}},associations:{},events:{}}});a.prototype.init=function(){this._aCommands=[];this._aUngroupFields=[];};a.prototype.undo=function(){var u=this._aUngroupFields;var j=[];var f=[];var F=[];var b=[];if(u){for(var i=0;i<u.length;i++){var e=sap.ui.getCore().byId(u[i].controlId);var d=u[i];j.push(e.getFields()[0].getMetadata().getName());f.push(d["sap:label"]);var p="";if(d.isComplexProperty){p=d.complexTypePropertyName+"/"+d.name;}else{p=d.name;}F.push(p);b.push(d.valueProperty);var o=sap.ui.rta.command.CommandFactory.getCommandFor(e,"Hide");o.execute();}var A=U.createNewAddFieldsCommand(this.getSmartForm(),e.getParent(),0,j,f,b,F);A.execute();}};a.prototype.execute=function(){var t=this;return this._createUngroupCommands().then(function(){for(var i=0;i<t._aCommands.length;i++){t._aCommands[i].execute();}t._updateElement();t.getElement().destroy();});};a.prototype.getCommands=function(){return this._aCommands;};a.prototype.serialize=function(){var s=[];for(var i=0;i<this._aCommands.length;i++){s.push(this._aCommands[i].serialize());}return s;};a.prototype._createUngroupCommands=function(){var t=this;var g=this.getElement().getParent();if(this._aCommands.length>0){return Promise.resolve();}var s=sap.ui.rta.controlAnalyzer.ControlAnalyzerFactory.getControlAnalyzerFor(this.getSmartForm());return s.prepare().then(function(){var h=s.getHiddenElements();var f=t.getElement().getFields();for(var i=0;i<f.length;i++){var F=f[i];var p=U.getElementBindingPaths(F);var b=U.findFieldBindingPathInFieldsArray(p,h);var o=h[b];o["valueProperty"]=p[b].valueProperty;if(o&&o.controlId){var G=sap.ui.getCore().byId(o.controlId);var u=sap.ui.rta.command.CommandFactory.getCommandFor(G,"Unhide");t._aCommands.push(u);}else if(o&&!o.controlId){var P=t._getBindingPath(o);var n=U.createNewAddFieldsCommand(t.getSmartForm(),g,0,[F.getMetadata().getName()],[o["sap:label"]],[p[o.name].valueProperty],[P]);t._aCommands.push(n);o["controlId"]=n.getNewControlId();}t._aUngroupFields.push(o);}});};a.prototype._updateElement=function(){sap.ui.getCore().applyChanges();if(this._aUngroupFields.length===0||(this.getElement()&&!this.getElement().bIsDestroyed)){return;}var p=[];for(var i=0;i<this._aUngroupFields.length;i++){p.push(this._getBindingPath(this._aUngroupFields[i]));}var e=U.createNewSmartFormGroupElementId(this.getSmartForm(),p);this.setElement(sap.ui.getCore().byId(e));};a.prototype._getBindingPath=function(d){var p="";if(d.isComplexProperty){p=d.complexTypePropertyName+"/"+d.name;}else{p=d.name;}return p;};return a;},true);
