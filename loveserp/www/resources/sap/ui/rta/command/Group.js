/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/rta/command/BaseCommand','sap/ui/rta/Utils','sap/ui/rta/controlAnalyzer/ControlAnalyzerFactory','sap/ui/dt/ElementDesignTimeMetadata'],function(B,U,C,E){"use strict";var G=B.extend("sap.ui.rta.command.Group",{metadata:{library:"sap.ui.rta",properties:{source:{type:"object"},index:{type:"number"},labels:{type:"array"},jsTypes:{type:"array"},fieldValues:{type:"array"},valuePropertys:{type:"array"},groupFields:{type:"array"},smartForm:{type:"object"}},associations:{},events:{}}});G.prototype.init=function(){this._aCommands=[];this._aOdataFields=[];};G.prototype.undo=function(){this._updateElement();for(var i=0;i<this._aCommands.length;i++){this._aCommands[i].undo();}this.getElement().destroy();};G.prototype.execute=function(){var t=this;return this._createGroupCommands().then(function(){for(var i=0;i<t._aCommands.length;i++){t._aCommands[i].execute();}});};G.prototype.getCommands=function(){return this._aCommands;};G.prototype.serialize=function(){var s=[];for(var i=0;i<this._aCommands.length;i++){s.push(this._aCommands[i].serialize());}return s;};G.prototype._updateElement=function(){var t=this;sap.ui.getCore().applyChanges();var p=this._aOdataFields.map(function(f){return t._getBindingPath(f);});var e=U.createNewSmartFormGroupElementId(this.getSmartForm(),p);this.setElement(sap.ui.getCore().byId(e));};G.prototype._createGroupCommands=function(){if(this._aCommands.length>0){return Promise.resolve();}var t=this;var s=sap.ui.rta.controlAnalyzer.ControlAnalyzerFactory.getControlAnalyzerFor(this.getSmartForm());var g=this.getGroupFields();return s.prepare().then(function(){var J=[];var f=[];var F=[];var a=[];var h=s.getHiddenElements();t._aOdataFields=[];for(var i=0;i<g.length;i++){var b=g[i].getFields();for(var z=0;z<b.length;z++){var o=b[z];var p=U.getElementBindingPaths(o);var c=U.findFieldBindingPathInFieldsArray(p,h);var d=h[c];var P=t._getBindingPath(d);t._aOdataFields.push(d);J.push(o.getMetadata().getName());f.push(d["fieldLabel"]);F.push(P);a.push(p[c].valueProperty);}var e=sap.ui.rta.command.CommandFactory.getCommandFor(g[i],"Hide");t._aCommands.push(e);}var n=U.createNewSmartFormGroupElementId(t.getSmartForm(),F);if(sap.ui.getCore().byId(n)){var k=sap.ui.getCore().byId(n);var l=k.getParent();return l.getMetadata().loadDesignTime().then(function(){var D=l.getMetadata().getDesignTime();var m=sap.ui.rta.command.CommandFactory.getCommandFor(k,"Unhide");var q=sap.ui.rta.command.CommandFactory.getCommandFor(l,"Move",{movedElements:[{element:k,sourceIndex:0,targetIndex:t.getIndex()}],target:{publicAggregation:"formElements",aggregation:"formElements",parent:l},source:{publicAggregation:"formElements",aggregation:"formElements",parent:l}},new E({data:D}));var N;for(var j=0;j<f.length;j++){N=N?N+"/"+f[j]:f[j];}var r=sap.ui.rta.command.CommandFactory.getCommandFor(k,"Rename",{newValue:N});t._aCommands.push(r);t._aCommands.push(m);t._aCommands.push(q);});}else{t._aCommands.push(U.createNewAddFieldsCommand(t.getSmartForm(),t.getSource().getParent(),t.getIndex(),J,f,a,F));}});};G.prototype._getBindingPath=function(d){var p="";if(d.isComplexProperty){p=d.complexTypePropertyName+"/"+d.name;}else{p=d.name;}return p;};return G;},true);
