(function(){"use strict";jQuery.sap.require("sap.ovp.ui.ObjectStream");jQuery.sap.require("sap.ovp.cards.AnnotationHelper");sap.ui.controller("sap.ovp.cards.stack.Stack",{onInit:function(){var v=this._oCard=this.getView().byId("stackContent");v.addEventDelegate({onclick:this.openStack.bind(this),onkeydown:function(e){if(!e.shiftKey&&(e.keyCode==13||e.keyCode==32)){e.preventDefault();this.openStack();}}.bind(this)});},onExit:function(){if(this.oObjectStream){this.oObjectStream.destroy();}},onAfterRendering:function(){var v=this.getView();var m=v.getModel();var c=v.getModel("ovpCardProperties");var e=c.getProperty("/entitySet");var o=c.getProperty("/objectStreamCardsSettings");var M=m.getMetaModel();var E=M.getODataEntitySet(e);var a=M.getODataEntityType(E.entityType);var A=c.getProperty("/annotationPath");var b=(A)?A.split(","):[];var d,O,g;if(this.getOwnerComponent()&&this.getOwnerComponent().getComponentData()){d=this.getOwnerComponent().getComponentData().appComponent;O=this.getOwnerComponent().getComponentData().mainComponent;}if(O){g=O.getView().byId("ovpGlobalFilter");}function f(K){if(K==="ovpCardProperties"){return c;}else if(K==="dataModel"){return m;}else if(K==="_ovpCache"){return{};}}var F=[{getSetting:f,bDummyContext:true},E].concat(b);var B=sap.ovp.cards.AnnotationHelper.formatItems.apply(this,F);var h=sap.ui.base.BindingParser.complexParser(B);var s=c.getProperty("/objectStreamCardsNavigationProperty");var S=s?true:false;var i;var j=c.getProperty("/objectStreamCardsTemplate");if(S){if(j==="sap.ovp.cards.quickview"){jQuery.sap.log.error("objectStreamCardsTemplate cannot be 'sap.ovp.cards.quickview' when objectStreamCardsNavigationProperty is provided");this.setErrorState();return;}i=this._determineFilterPropertyId(m,E,a,s);o.entitySet=m.getMetaModel().getODataAssociationSetEnd(a,s).entitySet;}else{if(j!=="sap.ovp.cards.quickview"){jQuery.sap.log.error("objectStreamCardsTemplate must be 'sap.ovp.cards.quickview' when objectStreamCardsNavigationProperty is not provided");this.setErrorState();return;}var I=null;var k=c.getProperty("/identificationAnnotationPath");var l=(k)?k.split(","):[];if(l&&l.length>1){I=l[1];}if(I){o.identificationAnnotationPath=I;}if(a["com.sap.vocabularies.UI.v1.HeaderInfo"]&&a["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName&&a["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName.String){o.title=a["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName.String;}else{o.title=a.name;}o.entitySet=e;}h.factory=function(r,C){var u=o,w;if(S){w={filters:[{path:i.foreignKey,operator:"EQ",value1:C.getProperty(i.key)}]};u=jQuery.extend(w,o);}var x=sap.ui.component({name:c.getProperty("/objectStreamCardsTemplate"),componentData:{model:m,settings:u,appComponent:d,mainComponent:O}});if(g){x.oComponentData.globalFilter={getFilterDataAsString:g.getDataSuiteFormat.bind(g)};}var y=v.getModel("@i18n");if(y){x.setModel(y,"@i18n");}var z=new sap.ui.core.ComponentContainer({component:x});z.setBindingContext=function(C){x.setBindingContext(C);};return z;};var n=c.getObject("/title");var p=new sap.m.Link({text:n,subtle:true,press:this.handleObjectStreamTitlePressed.bind(this)}).addStyleClass("sapOvpObjectStreamHeader");p.addCustomData(new sap.ovp.ui.CustomData({key:"tabindex",value:"0",writeToDom:true}));p.addCustomData(new sap.ovp.ui.CustomData({key:"aria-label",value:n,writeToDom:true}));p.addCustomData(new sap.ovp.ui.CustomData({key:"role",value:"heading",writeToDom:true}));this.oObjectStream=new sap.ovp.ui.ObjectStream({title:p,content:h});this.oObjectStream.setModel(m);if(!S){var N=this.getEntityNavigationEntries();if(N.length>0){var q=N[0].label;var P=this._createPlaceHolder(n,q);var t=this;P.addEventDelegate({onclick:function(){t.doNavigation(null);}});this.oObjectStream.setPlaceHolder(P);}}var L=this.oObjectStream.getBinding("content");L.attachDataReceived(function(){var r=this.getView().getModel("ovpCardProperties").getObject("/category"),u=L.getCurrentContexts().length,w=L.getLength();v.byId("stackSize").setText(u);v.byId("stackTotalSize").setText(sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("Total_Size_Stack_Card",[w]));var x=this.getView().byId("stackContent").getDomRef();jQuery(x).attr("aria-label",sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("stackCardContent",[u,w,r]));var y=this.getView().byId("stackSize").getDomRef();jQuery(y).attr("aria-label",sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("stackCard",[u]));},this);},_determineFilterPropertyId:function(m,e,E,n){var N,a=E.namespace,r,A;for(var i=0;i<E.navigationProperty.length;i++){if(E.navigationProperty[i].name===n){N=E.navigationProperty[i];break;}}r=N.relationship;A=sap.ovp.cards.AnnotationHelper.getAssociationObject(m,r,a);var R=A.referentialConstraint,f={};if(R){f.foreignKey=R.dependent.propertyRef[0].name;f.key=R.principal.propertyRef[0].name;return f;}},_createPlaceHolder:function(o,a){var i=new sap.ui.core.Icon({src:"sap-icon://display-more",useIconTooltip:false,layoutData:new sap.m.FlexItemData({alignSelf:sap.m.FlexAlignSelf.Center,styleClass:"sapOvpStackPlaceHolderIconContainer"})});i.addStyleClass("sapOvpStackPlaceHolderIcon");var s=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("SeeMoreContentAppName",[o,a]);var t=new sap.m.Text({text:s,textAlign:"Center",layoutData:new sap.m.FlexItemData({alignSelf:sap.m.FlexAlignSelf.Center,maxWidth:"14rem"})});t.addCustomData(new sap.ovp.ui.CustomData({key:"role",value:"heading",writeToDom:true}));t.addCustomData(new sap.ovp.ui.CustomData({key:"aria-label",value:s,writeToDom:true}));t.addStyleClass("sapOvpStackPlaceHolderTextLine");var d=new sap.m.VBox({items:[t]});d.addStyleClass("sapOvpStackPlaceHolderLabelsContainer");d.addCustomData(new sap.ovp.ui.CustomData({key:"tabindex",value:"0",writeToDom:true}));d.addCustomData(new sap.ovp.ui.CustomData({key:"role",value:"button",writeToDom:true}));var v=new sap.m.VBox({items:[i,d]});v.addStyleClass("sapOvpStackPlaceHolder");v.addEventDelegate({onkeydown:function(e){if(!e.shiftKey&&(e.keyCode==13||e.keyCode==32)){e.preventDefault();e.srcControl.$().click();}}});return v;},openStack:function(){if(this.oObjectStream){var l=this.oObjectStream.getBinding("content");if(l.getCurrentContexts().length>0){var c=this.getView().$().width();this.getView().addDependent(this.oObjectStream);this.oObjectStream.setModel(this.getView().getModel("@i18n"),"@i18n");this.oObjectStream.open(c,this._oCard);}}},handleObjectStreamTitlePressed:function(e){this.doNavigation(null);}});})();
